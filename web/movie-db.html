<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Movie Database Search and Save</title>
<link rel="stylesheet" href="movie-db.css" title="mdb-css">
<meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<h1>Movie Database Search and Save</h1>
<!-- <form> -->
<label>Title to search for:<br/>
<input type="text" id="searchTitle" required>
</label>
<button id="searchTitleBtn" onclick="searchTitle()">Search</button>
<!-- </form> -->
<div id="moreDetails">
</div>
<div id="searchResults">
</div>
<div id="savedMoviesList">
</div>
<script>
const maxResultsRetrieved = 10; //Max number of results that can be retrieved at once
var fullListOfMoviesString = localStorage.getItem("fullListOfMovies");
var fullListOfMoviesObj;
if (fullListOfMoviesString === null) {
	fullListOfMoviesObj = {movies:[]};
}
else {
	fullListOfMoviesObj = JSON.parse(fullListOfMoviesString);
}
	console.log("fullListOfMoviesString: ");
	console.log(fullListOfMoviesString);
	console.log("fullListOfMoviesObj: ");
	console.log(fullListOfMoviesObj);
	viewSavedMoviesList();

function searchTitle(searchResultsPage = 1) {
	var searchTitle = document.getElementById("searchTitle").value;
	console.log(searchTitle);
	var searchText = "s=" + searchTitle;
	var searchType = "s";
	search(searchText, searchType, searchResultsPage);
}

function search (searchText, searchType, searchResultsPage = 1) {
	var apiKey = "ece24955";
	var page;
	page = "&page=" + searchResultsPage;
	console.log(page);
	var type = ""; //"&type=series"; //"&type=episode";
	var url = "https://www.omdbapi.com/?" + searchText + type + page + "&apikey=" + apiKey;
	var req = new XMLHttpRequest();
	req.open("GET", url);
	req.onreadystatechange = function() {
		if ((this.readyState == 4) && (this.status == 200)) {
			console.log(searchText);
			var searchResultsText = this.responseText;
			var searchResultsObj = JSON.parse(searchResultsText);
			console.log(searchResultsObj);
			console.log(typeof(searchResultsObj));
			if (searchType == "s") {
				var moreDetails = document.getElementById("moreDetails");
				moreDetails.innerHTML = "";
				moreDetails.classList.remove("topBottomBorders");
				if (searchResultsObj.Response == "False") {
					console.log("Failed to find movie");
					document.getElementById("searchResults").innerHTML = "<h2>No results found!</h2>";
				}
				else {
					console.log(searchResultsObj.Search.length);
					displaySearchResults(searchResultsObj, searchResultsPage);
				}
			}
			else if (searchType == "i") {
				displayIDResult(searchResultsObj);
			}
		}
	};
	req.send();
}

function displaySearchResults(searchResultsObj, searchResultsPage) {
	var searchResults = "<h2>Search Results:</h2><ol id='searchResultsList' start='" + (searchResultsPage * 10 - 9) + "'>";
	for (var i = 0; i < searchResultsObj.Search.length; i++) {
		var imdbID = searchResultsObj.Search[i].imdbID;
		searchResults += "<li><img class='poster' src='" + searchResultsObj.Search[i].Poster + "' onerror='this.src=&quot;no-img.png&quot;;this.classList=&quot;posterNoImg&quot;;'><span class='resultsTitle'>" + searchResultsObj.Search[i].Title + "</span><br/>" + "<strong>Type:</strong> " + searchResultsObj.Search[i].Type + "<br/>" + "<strong>Year:</strong> " + searchResultsObj.Search[i].Year + "<br/>" + "<strong>IMDb ID:</strong> " + "<span class='imdbID'>" + imdbID + "</span><br/> <button id='viewDetailsBtn_" + imdbID + "' class='viewDetailsBtn' onclick='searchID(&quot;" + imdbID + "&quot;);'>View more details</button></li>";
	}
	searchResults += "</ol>";
	searchResults += "<p>Page: " + searchResultsPage + "</p>";
	if (searchResultsPage > 1) {
		searchResults += "<button onclick='searchTitle(" + (searchResultsPage - 1) + ");'>Previous Page</button> ";
	}
	if (searchResultsObj.Search.length == maxResultsRetrieved) { //Max number of results that can be retrieved at once
		searchResults += "<button onclick='searchTitle(" + (searchResultsPage + 1) + ");'>Next Page</button>";
	}
	document.getElementById("searchResults").innerHTML = searchResults;
}

function searchID(imdbID) {
	console.log(imdbID);
	var searchText = "i=" + imdbID;
	var searchType = "i";
	search(searchText, searchType);
}

function displayIDResult(searchResultsObj) {
	var idResult = "<h2>More Details:<br/> <span class='idDetailsTitle'>" + searchResultsObj.Title +"</span></h2><p>";
	var imdbID = searchResultsObj.imdbID;
	idResult += "<img class='idDetailsPoster' src='" + searchResultsObj.Poster + "' onerror='this.src=&quot;&quot;'><br/>" + "<strong>Type:</strong> " + searchResultsObj.Type + "<br/>" + "<strong>Genre:</strong> " + searchResultsObj.Genre + "<br/>" + "<strong>Year:</strong> " + searchResultsObj.Year + "<br/>" + "<strong>Released:</strong> " + searchResultsObj.Released + "<br/>" + "<strong>Runtime:</strong> " + searchResultsObj.Runtime + "<br/>" + "<strong>Director:</strong> " + searchResultsObj.Director + "<br/>" + "<strong>Actors:</strong> " + searchResultsObj.Actors + "<br/>" + "<strong>IMDb ID:</strong> " + "<span class='imdbID'>" + imdbID + "</span><br/> <button id='addMovieBtn_" + imdbID + "' onclick='addMovie(&quot;" + imdbID + "&quot;);'>Add Movie to List</button>";
	var movieDataString = JSON.stringify(searchResultsObj);
	console.log(movieDataString);
	idResult += "<span id='movieDataString'>" + movieDataString + "</span></p>";
	document.getElementById("moreDetails").innerHTML = idResult;
	document.body.scrollTop = document.documentElement.scrollTop = 0;
	
	var moreDetails = document.getElementById("moreDetails");
	moreDetails.classList.add("topBottomBorders");

	//Add button to show plot summary
}

function addMovie(imdbID) {
	console.log("Add Movie: " + imdbID);
	var movieDataString = document.getElementById("movieDataString").innerHTML;

	var savedMovieObj = JSON.parse(movieDataString);
	console.log("savedMovieObj: ");
	console.log(savedMovieObj);

	fullListOfMoviesObj.movies.push(savedMovieObj);
	console.log("fullListofMoviesObj: ");
	console.log(fullListOfMoviesObj);

	var fullListOfMovies = JSON.stringify(fullListOfMoviesObj);
	console.log("fullListofMovies: ");
	console.log(fullListOfMovies);
	localStorage.setItem("fullListOfMovies", fullListOfMovies);
	viewSavedMoviesList();
}

function viewSavedMoviesList() {
	fullListOfMoviesString = localStorage.getItem("fullListOfMovies");
	console.log("fullListOfMoviesString: ");
	console.log(fullListOfMoviesString);
	fullListOfMoviesObj = JSON.parse(fullListOfMoviesString);
	console.log("fullListOfMoviesObj: ");
	console.log(fullListOfMoviesObj);
	var savedMoviesList = document.getElementById("savedMoviesList");
	savedMoviesList.innerHTML = "<h2>List of Saved Movies</h2> ";
	if ((fullListOfMoviesObj != null) && (fullListOfMoviesObj.movies.length != 0)) {
		savedMoviesList.innerHTML = "<ol>";
		for (var i = 0; i < fullListOfMoviesObj.movies.length; i++) {
		savedMoviesList.innerHTML += "<li>" + fullListOfMoviesObj.movies[i].Title + " <em>(" + fullListOfMoviesObj.movies[i].Year + ")</em> <button id='viewDetailsBtn_" + fullListOfMoviesObj.movies[i].imdbID + "' class='viewDetailsBtn' onclick='searchID(&quot;" + fullListOfMoviesObj.movies[i].imdbID + "&quot;);'>View more details</button> <button id='removeFromListBtn_" + fullListOfMoviesObj.movies[i].imdbID + "' class='removeFromList' onclick='removeFromList(" + i + ");'>Remove</button></li>";
		}
		savedMoviesList.innerHTML += "</ol>";
	}
	else {
		savedMoviesList.innerHTML += "<p><em>No saved movies found</em></p>";
	}

	window.scroll(0,2000);
}

function removeFromList(i) {
	fullListOfMoviesObj.movies.splice(i,1);
	fullListOfMoviesString = JSON.stringify(fullListOfMoviesObj);
	console.log("fullListofMovies: ");
	console.log(fullListOfMoviesString);
	localStorage.setItem("fullListOfMovies", fullListOfMoviesString);
	viewSavedMoviesList();
}
</script>
</body>
</html>